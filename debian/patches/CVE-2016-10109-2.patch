From 3aaab9d998b5deb16a246cc7517e44144d281d3b Mon Sep 17 00:00:00 2001
From: Peter Wu <peter@lekensteyn.nl>
Date: Sun, 25 Dec 2016 23:37:51 +0100
Subject: SCard: check for a valid hContext handles

Reject invalid (zero) hContext handles and log the event.
---
 src/winscard_svc.c | 13 +++++++++++++
 1 file changed, 13 insertions(+)

Index: pcsc-lite-1.8.14/src/winscard_svc.c
===================================================================
--- pcsc-lite-1.8.14.orig/src/winscard_svc.c	2017-01-06 10:09:51.928029252 -0500
+++ pcsc-lite-1.8.14/src/winscard_svc.c	2017-01-06 10:09:51.904029011 -0500
@@ -802,6 +802,12 @@
 	LONG rv;
 	int lrv;
 
+	if (0 == threadContext->hContext)
+	{
+		Log1(PCSC_LOG_ERROR, "Invalidated handle");
+		return SCARD_E_INVALID_HANDLE;
+	}
+
 	if (threadContext->hContext != hContext)
 		return SCARD_E_INVALID_VALUE;
 
@@ -881,6 +887,12 @@
 {
 	LONG retval = SCARD_E_INVALID_VALUE;
 
+	if (0 == threadContext->hContext)
+	{
+		Log1(PCSC_LOG_ERROR, "Invalidated handle");
+		return SCARD_E_INVALID_HANDLE;
+	}
+
 	if (threadContext->hContext == hContext)
 	{
 		/*
@@ -920,6 +932,7 @@
 	return retval;
 }
 
+/* Pre-condition: MSGCheckHandleAssociation must succeed. */
 static LONG MSGRemoveHandle(SCARDHANDLE hCard, SCONTEXT * threadContext)
 {
 	int lrv;
